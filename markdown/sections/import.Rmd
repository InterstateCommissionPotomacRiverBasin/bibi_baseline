---
title: "R Notebook"
output: html_document
---

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(leaflet)
```

The `clean_string()` function modifies character objects by removing leading/trailing white space, converting all characters to lower case, and replacing all spaces (" ") with an underscore ("_"). These specifications elimnate common typos and standardize character objects.
```{r}
clean_string <- function(x) {
  x %>% 
    stringr::str_trim() %>% 
    tolower() %>% 
    stringr::str_replace_all("\\s+", " ") %>% 
    stringr::str_replace_all(" ", "_") %>%  
    if_else(. == "", as.character(NA), .)
}
```

The `clean_up()` function is a wrapper for `clean_string()`. This function applies `clean_string()` to the column headers and character columns of data frames. Again, this process standardizes character values and makes it easier work with the data.
```{r}
clean_up <- function(x) {
  x %>% 
    rename_all(clean_string) %>% 
    mutate_if(is.character, funs(clean_string))%>% 
    distinct()
}
```

```{r}
file.dir <- "H:/Projects/Chessie_BIBI/report/FINAL_May25_2017/2017_Data/Scores_Ratings/BIBI_Scores_Ratings_06292017.xlsx"
```


```{r}
bioregion.df <- read_excel(file.dir,
                           sheet = "Bioregion_Family",
                           col_types = c(
                             rep("text", 2),
                             "numeric",
                             rep("text", 2),
                             "date", 
                             "text",
                             rep("numeric", 2),
                             rep("text", 5),
                             rep("numeric", 5),
                             "text"
                           ),
                           na = c("", "NA", "na", " ")) %>% 
  clean_up()

region.df <- read_excel(file.dir,
                        sheet = "Region_Family",
                        col_types = c(
                             rep("text", 2),
                             "numeric",
                             rep("text", 2),
                             "date", 
                             "text",
                             rep("numeric", 2),
                             rep("text", 5),
                             rep("numeric", 5),
                             "text"
                           ),
                           na = c("", "NA", "na", " ")) %>% 
  clean_up()
```

```{r}
data.df <- bind_rows(region.df, bioregion.df) %>% 
  rename(subspatial = spatial) %>% 
  mutate(spatial = if_else(subspatial %in% c("coast", "inland"), 
                           "region", "bioregion")) %>% 
  select(spatial, everything())
```

```{r}
data.df <- data.df %>% 
  group_by(spatial, station_id, agency_code) %>% 
  mutate(count = n()) %>% 
  ungroup()
```


```{r}
sub.df <- data.df %>% 
  filter(count >= 10) %>% 
  mutate(spatial2 = spatial,
         station_id2 = station_id) %>% 
  unite(unique_id, station_id2, spatial2) %>% 
  group_by(unique_id) %>% 
  mutate(sd = sd(final_score)) %>% 
  ungroup() %>% 
  group_by(subspatial) %>% 
  mutate(mean_sd = mean(sd),
         median_sd = median(sd))

test <- sub.df %>% 
  select(subspatial, mean_sd, median_sd) %>% 
  distinct()
```

```{r, fig.width = 10, fig.height = 150}
ggplot(sub.df, aes(date, final_score, group = unique_id, color = spatial)) + 
  geom_line() +
  facet_wrap(~unique_id, ncol = 2)
```

```{r}
ggplot(sub.df, aes(subspatial, sd)) +
  geom_boxplot() +
  ylab("Standard Deviation") +
  xlab("")

```


